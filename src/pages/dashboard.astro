---
import Layout from '../components/Layout.astro';
import KPIGrid from '../components/KPIGrid.astro';
import LineChart from '../components/LineChart.astro';
import { requireUser } from '../lib/auth';
import { getDashboardData } from '../lib/firestore/summaries';
import { formatDate, getToday, parseDateKey } from '../lib/dates';

const user = await requireUser(Astro.request);

// Parse date range from URL params
const fromParam = Astro.url.searchParams.get('from');
const toParam = Astro.url.searchParams.get('to');

// Default to today for both dates if no dates provided
const today = getToday();

const fromDate = fromParam ? parseDateKey(fromParam) : today;
const toDate = toParam ? parseDateKey(toParam) : today;

const dashboardData = await getDashboardData(fromDate, toDate);

// Calculate days difference for display
const daysDiff = Math.ceil((toDate.getTime() - fromDate.getTime()) / (1000 * 60 * 60 * 24));
---

<Layout user={user} title="Dashboard - Company Ledger">
	<h1 class="text-2xl font-bold text-gray-900 mb-6">Dashboard</h1>

	<div class="mb-6 bg-white rounded-lg shadow p-4">
		<label class="block text-sm font-medium text-gray-700 mb-3">Chart Date Range</label>
		<form method="GET" action="/dashboard" class="flex flex-wrap items-end gap-4">
			<div>
				<label for="from" class="block text-xs text-gray-600 mb-1">From Date</label>
				<input
					type="date"
					id="from"
					name="from"
					value={formatDate(fromDate)}
					class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
				/>
			</div>
			<div>
				<label for="to" class="block text-xs text-gray-600 mb-1">To Date</label>
				<input
					type="date"
					id="to"
					name="to"
					value={formatDate(toDate)}
					class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
				/>
			</div>
			<button
				type="submit"
				class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
			>
				Update Chart
			</button>
			<a
				href="/dashboard"
				class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
			>
				Reset
			</a>
		</form>
	</div>

	<KPIGrid 
		title="Today" 
		data={dashboardData.today ? {
			label: 'Today',
			income: dashboardData.today.incomeCents,
			expense: dashboardData.today.expenseCents,
			net: dashboardData.today.netCents,
		} : null}
	/>

	<KPIGrid 
		title="This Week" 
		data={dashboardData.week ? {
			label: 'This Week',
			income: dashboardData.week.incomeCents,
			expense: dashboardData.week.expenseCents,
			net: dashboardData.week.netCents,
		} : null}
	/>

	<KPIGrid 
		title="This Month" 
		data={dashboardData.month ? {
			label: 'This Month',
			income: dashboardData.month.incomeCents,
			expense: dashboardData.month.expenseCents,
			net: dashboardData.month.netCents,
		} : null}
	/>

	<LineChart data={dashboardData.dailyChart} title={`Daily Trends (${formatDate(fromDate)} to ${formatDate(toDate)})`} />

	<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
		<div class="bg-white rounded-lg shadow p-6">
			<h2 class="text-lg font-semibold text-gray-900 mb-4">Weekly Summary (Last 8 Weeks)</h2>
			<div class="overflow-x-auto">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Week</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Income</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expense</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Net</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						{dashboardData.weeklyTable.map(week => (
							<tr>
								<td class="px-4 py-3 text-sm text-gray-900">{week.weekKey}</td>
								<td class="px-4 py-3 text-sm text-green-600">
									€{(week.incomeCents / 100).toFixed(2)}
								</td>
								<td class="px-4 py-3 text-sm text-red-600">
									€{(week.expenseCents / 100).toFixed(2)}
								</td>
								<td class={`px-4 py-3 text-sm font-medium ${week.netCents >= 0 ? 'text-green-600' : 'text-red-600'}`}>
									€{(week.netCents / 100).toFixed(2)}
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
		</div>

		<div class="bg-white rounded-lg shadow p-6">
			<h2 class="text-lg font-semibold text-gray-900 mb-4">Monthly Summary (Last 12 Months)</h2>
			<div class="overflow-x-auto">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Income</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expense</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Net</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						{dashboardData.monthlyTable.map(month => (
							<tr>
								<td class="px-4 py-3 text-sm text-gray-900">{month.monthKey}</td>
								<td class="px-4 py-3 text-sm text-green-600">
									€{(month.incomeCents / 100).toFixed(2)}
								</td>
								<td class="px-4 py-3 text-sm text-red-600">
									€{(month.expenseCents / 100).toFixed(2)}
								</td>
								<td class={`px-4 py-3 text-sm font-medium ${month.netCents >= 0 ? 'text-green-600' : 'text-red-600'}`}>
									€{(month.netCents / 100).toFixed(2)}
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</Layout>
