---
import Layout from '../components/Layout.astro';
import KPIGrid from '../components/KPIGrid.astro';
import { requireAdmin } from '../lib/auth';
import { getDashboardData } from '../lib/firestore/summaries';
import { getToday, toMonthKey } from '../lib/dates';

const user = await requireAdmin(Astro.request);

const dashboardData = await getDashboardData();
const currentMonthKey = toMonthKey(getToday());
---

<Layout user={user} title="Dashboard - Company Ledger">
	<h1 class="text-2xl font-bold text-gray-900 mb-6">Dashboard</h1>
	{user.role === 'admin' && (
		<div class="mb-4">
			<a
				href={`/api/reports/monthly.pdf?month=${currentMonthKey}`}
				class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300"
			>
				Download Monthly PDF
			</a>
		</div>
	)}

	<KPIGrid 
		title="Today" 
		data={dashboardData.today ? {
			label: 'Today',
			income: dashboardData.today.incomeCents,
			expense: dashboardData.today.expenseCents,
			net: dashboardData.today.netCents,
			cash: dashboardData.todayPayments.cashCents,
			online: dashboardData.todayPayments.onlineCents,
		} : null}
	/>

	<KPIGrid 
		title="This Week" 
		data={dashboardData.week ? {
			label: 'This Week',
			income: dashboardData.week.incomeCents,
			expense: dashboardData.week.expenseCents,
			net: dashboardData.week.netCents,
			cash: dashboardData.weekPayments.cashCents,
			online: dashboardData.weekPayments.onlineCents,
		} : null}
	/>

	<KPIGrid 
		title="This Month" 
		data={dashboardData.month ? {
			label: 'This Month',
			income: dashboardData.month.incomeCents,
			expense: dashboardData.month.expenseCents,
			net: dashboardData.month.netCents,
			cash: dashboardData.monthPayments.cashCents,
			online: dashboardData.monthPayments.onlineCents,
		} : null}
	/>

	<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
		<div class="bg-white rounded-lg shadow p-6">
			<h2 class="text-lg font-semibold text-gray-900 mb-4">Weekly Summary (Last 8 Weeks)</h2>
			<div class="overflow-x-auto">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Week</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Income</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expense</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Net</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						{dashboardData.weeklyTable.map(week => (
							<tr>
								<td class="px-4 py-3 text-sm text-gray-900">{week.weekKey}</td>
								<td class="px-4 py-3 text-sm text-green-600">
									€{(week.incomeCents / 100).toFixed(2)}
								</td>
								<td class="px-4 py-3 text-sm text-red-600">
									€{(week.expenseCents / 100).toFixed(2)}
								</td>
								<td class={`px-4 py-3 text-sm font-medium ${week.netCents >= 0 ? 'text-green-600' : 'text-red-600'}`}>
									€{(week.netCents / 100).toFixed(2)}
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
		</div>

		<div class="bg-white rounded-lg shadow p-6">
			<h2 class="text-lg font-semibold text-gray-900 mb-4">Monthly Summary (Last 12 Months)</h2>
			<div class="overflow-x-auto">
				<table class="min-w-full divide-y divide-gray-200">
					<thead class="bg-gray-50">
						<tr>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Month</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Income</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expense</th>
							<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Net</th>
						</tr>
					</thead>
					<tbody class="bg-white divide-y divide-gray-200">
						{dashboardData.monthlyTable.map(month => (
							<tr>
								<td class="px-4 py-3 text-sm text-gray-900">{month.monthKey}</td>
								<td class="px-4 py-3 text-sm text-green-600">
									€{(month.incomeCents / 100).toFixed(2)}
								</td>
								<td class="px-4 py-3 text-sm text-red-600">
									€{(month.expenseCents / 100).toFixed(2)}
								</td>
								<td class={`px-4 py-3 text-sm font-medium ${month.netCents >= 0 ? 'text-green-600' : 'text-red-600'}`}>
									€{(month.netCents / 100).toFixed(2)}
								</td>
							</tr>
						))}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</Layout>
