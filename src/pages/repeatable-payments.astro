---
import Layout from '../components/Layout.astro';
import { requireAdmin } from '../lib/auth';
import { 
	listRepeatablePayments, 
	createRepeatablePayment, 
	deleteRepeatablePayment,
	toggleRepeatablePayment 
} from '../lib/firestore/repeatablePayments';
import { listActiveCategories, getOrCreatePaymentTypeCategory } from '../lib/firestore/categories';
import { auth } from '../lib/firebaseAdmin';
import { getToday, formatDate } from '../lib/dates';
import type { TransactionType, RepeatFrequency } from '../lib/types';

const user = await requireAdmin(Astro.request);

let success = false;
let error: string | null = null;

if (Astro.request.method === 'POST') {
	const formData = await Astro.request.formData();
	const action = formData.get('action')?.toString();

	if (action === 'create') {
		const name = formData.get('name')?.toString();
		const type = formData.get('type')?.toString() as TransactionType;
		const amountStr = formData.get('amount')?.toString();
		const categoryId = formData.get('categoryId')?.toString();
		const clickupId = formData.get('clickupId')?.toString() || '';
		const companyName = formData.get('companyName')?.toString() || '';
		const note = formData.get('note')?.toString() || '';
		const frequency = formData.get('frequency')?.toString() as RepeatFrequency;
		const startDateStr = formData.get('startDate')?.toString();
		const endDateStr = formData.get('endDate')?.toString();

		if (!name || !type || !amountStr || !categoryId || !frequency || !startDateStr) {
			error = 'All required fields must be filled';
		} else {
			try {
				const amountCents = Math.round(parseFloat(amountStr) * 100);
				const startDate = new Date(startDateStr + 'T00:00:00');
				const endDate = endDateStr ? new Date(endDateStr + 'T23:59:59') : undefined;

				if (amountCents <= 0) {
					error = 'Amount must be greater than 0';
				} else {
					// Handle payment type (cash/online) - get or create the category
					let finalCategoryId = categoryId;
					if (categoryId === 'cash' || categoryId === 'online') {
						const categoryName = categoryId === 'cash' ? 'Cash' : 'Online Payment';
						finalCategoryId = await getOrCreatePaymentTypeCategory(categoryName);
					}

					await createRepeatablePayment({
						name,
						type,
						amountCents,
						categoryId: finalCategoryId,
						clickupId: clickupId || undefined,
						companyName: companyName || undefined,
						note: note || undefined,
						frequency,
						startDate,
						endDate,
						active: true,
						createdBy: user.uid,
					});

					success = true;
				}
			} catch (err: any) {
				error = err.message || 'Failed to create repeatable payment';
			}
		}
	} else if (action === 'delete') {
		const id = formData.get('id')?.toString();
		if (!id) {
			error = 'Payment ID is required';
		} else {
			try {
				await deleteRepeatablePayment(id);
				success = true;
			} catch (err: any) {
				error = err.message || 'Failed to delete repeatable payment';
			}
		}
	} else if (action === 'toggle') {
		const id = formData.get('id')?.toString();
		if (!id) {
			error = 'Payment ID is required';
		} else {
			try {
				await toggleRepeatablePayment(id);
				success = true;
			} catch (err: any) {
				error = err.message || 'Failed to toggle repeatable payment';
			}
		}
	}
}

const repeatablePayments = await listRepeatablePayments();
const categories = await listActiveCategories();
const categoryMap = new Map(categories.map(c => [c.id, c.name]));

// Get user emails for display
const userIds = new Set(repeatablePayments.map(p => p.createdBy));
const userEmails = new Map<string, string>();
for (const uid of userIds) {
	try {
		const userRecord = await auth.getUser(uid);
		userEmails.set(uid, userRecord.email || uid);
	} catch {
		userEmails.set(uid, uid);
	}
}

function formatCurrency(cents: number): string {
	return new Intl.NumberFormat('en-US', {
		style: 'currency',
		currency: 'EUR',
	}).format(cents / 100);
}
---

<Layout user={user} title="Repeatable Payments - Company Ledger">
	<div class="flex justify-between items-center mb-6">
		<h1 class="text-2xl font-bold text-gray-900">Repeatable Payments</h1>
	</div>

	{success && (
		<div class="mb-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded">
			Operation completed successfully!
		</div>
	)}

	{error && (
		<div class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
			{error}
		</div>
	)}

	<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
		<!-- Add New Repeatable Payment Form -->
		<div class="bg-white rounded-lg shadow p-6">
			<h2 class="text-lg font-semibold text-gray-900 mb-4">Add Repeatable Payment</h2>
			<form method="POST" class="space-y-4">
				<input type="hidden" name="action" value="create" />
				
				<div>
					<label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
					<input
						type="text"
						id="name"
						name="name"
						required
						placeholder="e.g., Monthly Rent, Weekly Salary"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div>
					<label class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
					<div class="flex space-x-4">
						<label class="flex items-center">
							<input type="radio" name="type" value="income" class="mr-2" />
							<span>Income</span>
						</label>
						<label class="flex items-center">
							<input type="radio" name="type" value="expense" checked class="mr-2" />
							<span>Expense</span>
						</label>
					</div>
				</div>

				<div>
					<label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Amount (â‚¬) *</label>
					<input
						type="number"
						id="amount"
						name="amount"
						step="0.01"
						min="0"
						required
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div>
					<label for="categoryId" class="block text-sm font-medium text-gray-700 mb-1">Payment Type *</label>
					<select
						id="categoryId"
						name="categoryId"
						required
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value="">Select payment type</option>
						<option value="cash">Cash</option>
						<option value="online">Online Payment</option>
					</select>
				</div>

				<div>
					<label for="frequency" class="block text-sm font-medium text-gray-700 mb-1">Frequency *</label>
					<select
						id="frequency"
						name="frequency"
						required
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value="daily">Daily</option>
						<option value="weekly">Weekly</option>
						<option value="monthly" selected>Monthly</option>
						<option value="yearly">Yearly</option>
					</select>
				</div>

				<div>
					<label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
					<input
						type="date"
						id="startDate"
						name="startDate"
						value={formatDate(getToday())}
						required
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div>
					<label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date (Optional)</label>
					<input
						type="date"
						id="endDate"
						name="endDate"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
					<p class="text-xs text-gray-500 mt-1">Leave empty for indefinite repetition</p>
				</div>

				<div>
					<label for="clickupId" class="block text-sm font-medium text-gray-700 mb-1">Clickup Id</label>
					<input
						type="text"
						id="clickupId"
						name="clickupId"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div>
					<label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
					<input
						type="text"
						id="companyName"
						name="companyName"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div>
					<label for="note" class="block text-sm font-medium text-gray-700 mb-1">Note</label>
					<input
						type="text"
						id="note"
						name="note"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<button
					type="submit"
					class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
				>
					Create Repeatable Payment
				</button>
			</form>
		</div>

		<!-- List of Repeatable Payments -->
		<div class="bg-white rounded-lg shadow p-6">
			<h2 class="text-lg font-semibold text-gray-900 mb-4">All Repeatable Payments</h2>
			<div class="space-y-3">
				{repeatablePayments.length === 0 ? (
					<p class="text-gray-500 text-center py-4">No repeatable payments found. Create one to get started.</p>
				) : (
					repeatablePayments.map(payment => (
						<div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
							<div class="flex items-start justify-between mb-2">
								<div class="flex-1">
									<div class="flex items-center space-x-2 mb-1">
										<span class="font-semibold text-gray-900">{payment.name}</span>
										<span class={`px-2 py-1 text-xs rounded-full ${
											payment.type === 'income' 
												? 'bg-green-100 text-green-800' 
												: 'bg-red-100 text-red-800'
										}`}>
											{payment.type}
										</span>
										<span class={`px-2 py-1 text-xs rounded-full ${
											payment.active 
												? 'bg-green-100 text-green-800' 
												: 'bg-gray-100 text-gray-800'
										}`}>
											{payment.active ? 'Active' : 'Inactive'}
										</span>
									</div>
									<div class="text-sm text-gray-600 space-y-1">
										<p><strong>Amount:</strong> {formatCurrency(payment.amountCents)}</p>
										<p><strong>Frequency:</strong> {payment.frequency.charAt(0).toUpperCase() + payment.frequency.slice(1)}</p>
										<p><strong>Next Due:</strong> {formatDate(payment.nextDueDate)}</p>
										{payment.companyName && <p><strong>Company:</strong> {payment.companyName}</p>}
										{payment.clickupId && <p><strong>Clickup ID:</strong> {payment.clickupId}</p>}
										{payment.note && <p><strong>Note:</strong> {payment.note}</p>}
									</div>
								</div>
								<div class="flex flex-col space-y-2 ml-4">
									<a
										href={`/repeatable-payments/${payment.id}/edit`}
										class="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 text-center"
									>
										Edit
									</a>
									<form method="POST" class="inline">
										<input type="hidden" name="action" value="toggle" />
										<input type="hidden" name="id" value={payment.id} />
										<button
											type="submit"
											class="w-full px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
										>
											{payment.active ? 'Disable' : 'Enable'}
										</button>
									</form>
									<form method="POST" class="inline">
										<input type="hidden" name="action" value="delete" />
										<input type="hidden" name="id" value={payment.id} />
										<button
											type="submit"
											onclick="return confirm('Are you sure you want to delete this repeatable payment?')"
											class="w-full px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700"
										>
											Delete
										</button>
									</form>
								</div>
							</div>
						</div>
					))
				)}
			</div>
		</div>
	</div>
</Layout>
